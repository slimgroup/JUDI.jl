<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Seismic preconditionners Â· JUDI documentation</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">JUDI documentation</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../about/">About</a></li><li><a class="tocitem" href="../../installation/">Installation</a></li><li><a class="tocitem" href="../../basics/">Getting Started</a></li><li><span class="tocitem">JUDI API</span><ul><li><a class="tocitem" href="../../abstract_vectors/">Abstract vectors</a></li><li><a class="tocitem" href="../../data_structures/">Data Structures</a></li><li><a class="tocitem" href="../../linear_operators/">Linear Operators</a></li><li><a class="tocitem" href="../../preconditioners/">Preconditioners</a></li><li><a class="tocitem" href="../../io/">Input/Output</a></li><li><a class="tocitem" href="../../helper/">Helper Functions</a></li></ul></li><li><a class="tocitem" href="../../inversion/">Inversion</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../01_intro/">Introduction to JUDI</a></li><li><a class="tocitem" href="../02_fwi_example_NLopt/">FWI with Quasi-Newton methods from the NLopt library</a></li><li><a class="tocitem" href="../03_constrained_fwi/">FWI Example</a></li><li><a class="tocitem" href="../04_judi_leading_edge_tutorial/">Full-Waveform Inversion - Part 3: optimization</a></li><li><a class="tocitem" href="../05_custom_misfit/">FWI with user provided misfit function</a></li><li><a class="tocitem" href="../06_automatic_differentiation/">Automatic differentiation with JUDI</a></li><li class="is-active"><a class="tocitem" href>Seismic preconditionners</a><ul class="internal"><li><a class="tocitem" href="#Setup"><span>Setup</span></a></li><li><a class="tocitem" href="#Model-preconditionners"><span>Model preconditionners</span></a></li><li><a class="tocitem" href="#Data-Preconditionners"><span>Data Preconditionners</span></a></li><li><a class="tocitem" href="#Putting-it-together"><span>Putting it together</span></a></li></ul></li><li><a class="tocitem" href="../imaging_conditions/">Imaging conditions in JUDI</a></li><li><a class="tocitem" href="../quickstart/">Modeling and inversion with JUDI</a></li></ul></li><li><a class="tocitem" href="../../pysource/">Devito backend reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Seismic preconditionners</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Seismic preconditionners</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/slimgroup/JUDI.jl/blob/master/docs/src/tutorials/07_preconditionners.md" title="Edit on GitHub"><span class="docs-icon fab">ï‚›</span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Seismic-preconditionners"><a class="docs-heading-anchor" href="#Seismic-preconditionners">Seismic preconditionners</a><a id="Seismic-preconditionners-1"></a><a class="docs-heading-anchor-permalink" href="#Seismic-preconditionners" title="Permalink"></a></h1><p>This tutorials provide an overview of the preconditionners available in JUDI. THese examples are useful, if not necessary, for FWI, RTM and LSRTM to improve convergence and the quality of the result. Preconditionners fall in two categories:</p><ul><li><em>Model preconditioners</em>: these are linear operators that act on model domain vectors such as the velcoity or seismic image. </li><li><em>Data preconditionners</em>: there are linear operators that act on the data, i.e the shot records.</li></ul><p>We will show in the following example for both those categories. By design, the JUDI precontionners are designed to work on JUDI types such as <code>judiVector</code> or <code>PhysicalParameters</code> but can also be used directly on standard nion dimensional vectors.</p><h2 id="Setup"><a class="docs-heading-anchor" href="#Setup">Setup</a><a id="Setup-1"></a><a class="docs-heading-anchor-permalink" href="#Setup" title="Permalink"></a></h2><p>We setup this tutorial by creating a few objects we will be using. We consider </p><ul><li><p class="math-container">\[d_{\text{obs}}\]</p>a seismic dataset consiting of <code>nsrc</code> sources</li><li><p class="math-container">\[m\]</p>a squared slowness model</li><li><p class="math-container">\[dm\]</p>a model perturbation. For simplicity we derive this image directly for the squared slowness to avoid costly computation </li></ul><pre><code class="language-julia">using JUDI, SlimPlotting, JLD2, HDF5, LinearAlgebra, SegyIO, Images
data_path = JUDI.JUDI_DATA</code></pre><pre><code class="language-none">&quot;/Users/mathiaslouboutin/.julia/dev/JUDI/src/../data&quot;</code></pre><h3 id="Model"><a class="docs-heading-anchor" href="#Model">Model</a><a id="Model-1"></a><a class="docs-heading-anchor-permalink" href="#Model" title="Permalink"></a></h3><pre><code class="language-julia">n, d, o, m0, m = read(h5open(&quot;$(data_path)/overthrust_model.h5&quot;,&quot;r&quot;), &quot;n&quot;, &quot;d&quot;, &quot;o&quot;, &quot;m0&quot;, &quot;m&quot;);</code></pre><pre><code class="language-julia">figure(figsize=(10, 5))
plot_velocity(m&#39;.^(-.5), d; aspect=1, new_fig=false, cbar=true)</code></pre><p><img src="../07_preconditionners_files/07_preconditionners_5_0.png" alt="png"/></p><pre><code class="language-julia">figure(figsize=(10, 5))
plot_velocity(m0&#39;.^(-.5), d; aspect=1, new_fig=false, cbar=true)</code></pre><p><img src="../07_preconditionners_files/07_preconditionners_6_0.png" alt="png"/></p><pre><code class="language-julia">dm = m0 - m
figure(figsize=(10, 5))
plot_simage(dm&#39;, d; aspect=1, new_fig=false, cbar=true, name=&quot;dm&quot;)</code></pre><p><img src="../07_preconditionners_files/07_preconditionners_7_0.png" alt="png"/></p><pre><code class="language-julia">model = Model(n, d, o, m)
model0 = Model(n, d, o, m0)</code></pre><pre><code class="language-none">Model (n=(401, 121), d=(25.0f0, 25.0f0), o=(0.0f0, 0.0f0)) with parameters (:m, :rho)</code></pre><h3 id="Data"><a class="docs-heading-anchor" href="#Data">Data</a><a id="Data-1"></a><a class="docs-heading-anchor-permalink" href="#Data" title="Permalink"></a></h3><p>Now that we have a model, let&#39;s load and look at the data</p><pre><code class="language-julia">block = segy_read(&quot;$(data_path)/overthrust_shot_records.segy&quot;)
d_obs = judiVector(block);  # linearized observed data
# Source
src_geometry = Geometry(block; key = &quot;source&quot;)
wavelet = ricker_wavelet(src_geometry.t[1],src_geometry.dt[1],0.008f0)    # 8 Hz wavelet
q = diff(judiVector(src_geometry, wavelet), dims=1)</code></pre><pre><code class="language-none">[33m[1mâ”Œ [22m[39m[33m[1mWarning: [22m[39mFixed length trace flag set in stream: IOBuffer(data=UInt8[...], readable=true, writable=false, seekable=true, append=false, size=7076688, maxsize=Inf, ptr=3601, mark=-1)
[33m[1mâ”” [22m[39m[90m@ SegyIO ~/.julia/dev/SegyIO/src/read/read_file.jl:36[39m





judiVector{Float32, Matrix{Float32}} with 16 sources</code></pre><pre><code class="language-julia">figure(figsize=(10, 10))
plot_sdata(get_data(d_obs[1]); new_fig=false)</code></pre><p><img src="../07_preconditionners_files/07_preconditionners_11_0.png" alt="png"/></p><p>since some of the preconditionners are designed for inversion, let&#39;s create the data forr the background model and the propagators needed for imaging and inversion</p><pre><code class="language-julia">F = judiModeling(model, q.geometry, d_obs.geometry; options=Options(space_order=16))
J = judiJacobian(F(model0), q)
d0 = F(model0)*q</code></pre><pre><code class="language-none">Building forward operator
Operator `forward` ran in 0.11 s
Operator `forward` ran in 0.35 s
Operator `forward` ran in 0.35 s
Operator `forward` ran in 0.35 s
Operator `forward` ran in 0.35 s
Operator `forward` ran in 0.35 s
Operator `forward` ran in 0.35 s
Operator `forward` ran in 0.35 s
Operator `forward` ran in 0.35 s
Operator `forward` ran in 0.32 s
Operator `forward` ran in 0.35 s
Operator `forward` ran in 0.42 s
Operator `forward` ran in 0.35 s
Operator `forward` ran in 0.34 s
Operator `forward` ran in 0.35 s
Operator `forward` ran in 0.35 s





judiVector{Float32, Matrix{Float32}} with 16 sources</code></pre><pre><code class="language-julia">figure(figsize=(12, 10))
subplot(121)
plot_sdata(get_data(d_obs[1]); new_fig=false)
subplot(122)
plot_sdata(d0[1]; new_fig=false)</code></pre><p><img src="../07_preconditionners_files/07_preconditionners_14_0.png" alt="png"/></p><h2 id="Model-preconditionners"><a class="docs-heading-anchor" href="#Model-preconditionners">Model preconditionners</a><a id="Model-preconditionners-1"></a><a class="docs-heading-anchor-permalink" href="#Model-preconditionners" title="Permalink"></a></h2><pre><code class="language-julia">Dm = judiDepthScaling(model0)
Tm = judiTopmute(model0; taperwidth=0)
Il = inv(judiIllumination(model0))
mcases = [(Dm, &quot;Depth scaling&quot;), (Tm, &quot;Water layer mute&quot;), (Il, &quot;Illumination&quot;)]</code></pre><pre><code class="language-none">3-element Vector{Tuple{JUDI.ModelPreconditioner{Float32, Float32}, String}}:
 (DepthScaling{Float32, 2, 0.5f0}(48521, Float32[0.0 25.0 â€¦ 2975.0 3000.0]), &quot;Depth scaling&quot;)
 (TopMute{Float32, 2, 1}(48521, [21, 21, 21, 21, 21, 21, 21, 21, 21, 21  â€¦  21, 21, 21, 21, 21, 21, 21, 21, 21, 21], 0), &quot;Water layer mute&quot;)
 (judiIllumination{Float32, :u, -1, true}(&quot;judiIllumination{Float32, :u, 1, true}&quot;, Dict{SubString{String}, PhysicalParameter{Float32, 2}}(&quot;u&quot; =&gt; PhysicalParameter{Float32, 2} of size (401, 121) with origin (0.0f0, 0.0f0) and spacing (25.0f0, 25.0f0)), 48521), &quot;Illumination&quot;)</code></pre><pre><code class="language-julia">rtm = J&#39;*(d0 - d_obs)</code></pre><pre><code class="language-none">Building forward operator
Operator `forward` ran in 0.17 s
Building adjoint born operator
Operator `gradient` ran in 0.15 s
Operator `forward` ran in 0.28 s
Operator `gradient` ran in 0.15 s
Operator `forward` ran in 0.33 s
Operator `gradient` ran in 0.14 s
Operator `forward` ran in 0.34 s
Operator `gradient` ran in 0.14 s
Operator `forward` ran in 0.27 s
Operator `gradient` ran in 0.15 s
Operator `forward` ran in 0.46 s
Operator `gradient` ran in 0.15 s
Operator `forward` ran in 0.35 s
Operator `gradient` ran in 0.15 s
Operator `forward` ran in 0.40 s
Operator `gradient` ran in 0.15 s
Operator `forward` ran in 0.33 s
Operator `gradient` ran in 0.15 s
Operator `forward` ran in 0.33 s
Operator `gradient` ran in 0.15 s
Operator `forward` ran in 0.34 s
Operator `gradient` ran in 0.15 s
Operator `forward` ran in 0.30 s
Operator `gradient` ran in 0.15 s
Operator `forward` ran in 0.24 s
Operator `gradient` ran in 0.18 s
Operator `forward` ran in 0.36 s
Operator `gradient` ran in 0.16 s
Operator `forward` ran in 0.34 s
Operator `gradient` ran in 0.17 s
Operator `forward` ran in 0.35 s
Operator `gradient` ran in 0.17 s





PhysicalParameter{Float32, 2} of size (401, 121) with origin (0.0f0, 0.0f0) and spacing (25.0f0, 25.0f0)</code></pre><pre><code class="language-julia">plot_simage(Il.illums[&quot;u&quot;]&#39;; cbar=true, name=&quot;Illumination&quot;)</code></pre><p><img src="../07_preconditionners_files/07_preconditionners_18_0.png" alt="png"/></p><h3 id="Model-top-mute"><a class="docs-heading-anchor" href="#Model-top-mute">Model top mute</a><a id="Model-top-mute-1"></a><a class="docs-heading-anchor-permalink" href="#Model-top-mute" title="Permalink"></a></h3><p>This preconditionner is one of the simplest one and mutes the water layer, or more generally sets to zeros the top of the model.</p><pre><code class="language-julia">figure(figsize=(12, 12))
for (i, (pr, name)) in enumerate(mcases)
    subplot(3,1,i)
    plot_simage((pr*rtm)&#39;; new_fig=false, name=name)
end
tight_layout()</code></pre><p><img src="../07_preconditionners_files/07_preconditionners_20_0.png" alt="png"/></p><h2 id="Data-Preconditionners"><a class="docs-heading-anchor" href="#Data-Preconditionners">Data Preconditionners</a><a id="Data-Preconditionners-1"></a><a class="docs-heading-anchor-permalink" href="#Data-Preconditionners" title="Permalink"></a></h2><pre><code class="language-julia">Dt = judiTimeDerivative(d_obs, .5)
It = judiTimeIntegration(d_obs, .5)
Dmr = judiDataMute(q, d_obs; mode=:reflection, taperwidth=2)
Dmt = judiDataMute(q, d_obs; mode=:turning)
Df = judiFilter(d_obs, .1, 5.0)
dcases = [(Dt, &quot;Fractional (.5) time derivative&quot;),
         (It, &quot;Fractional (.5) time integration&quot;),
         (Dmr, &quot;Turning waves muting&quot;),
         (Dmt, &quot;Reflection muting&quot;),
         (Df, &quot;bandpass filter [.1, 5]Hz&quot;)];</code></pre><pre><code class="language-julia">figure(figsize=(12, 12))
for (i, (pr, name)) in enumerate(dcases)
    subplot(3,2,i)
    dloc = (pr*d_obs)[1]
    plot_sdata(dloc; new_fig=false, name=name)
end
tight_layout()</code></pre><p><img src="../07_preconditionners_files/07_preconditionners_23_0.png" alt="png"/></p><h2 id="Putting-it-together"><a class="docs-heading-anchor" href="#Putting-it-together">Putting it together</a><a id="Putting-it-together-1"></a><a class="docs-heading-anchor-permalink" href="#Putting-it-together" title="Permalink"></a></h2><p>Of course, in practice numerous preconditionners would be needed for the best result. Since our implementation relies on linear algebra abstractions, those preconditionners can be used with each other and in combination with propagators as well. We show a few examples below</p><pre><code class="language-julia"># Low frequency gradient with turing waves only for FWI
rtmlow = Il*Tm*J&#39;* Dmt * Df * (d0 - d_obs);</code></pre><pre><code class="language-none">Operator `forward` ran in 0.25 s
Operator `gradient` ran in 0.15 s
Operator `forward` ran in 0.32 s
Operator `gradient` ran in 0.14 s
Operator `forward` ran in 0.34 s
Operator `gradient` ran in 0.15 s
Operator `forward` ran in 0.26 s
Operator `gradient` ran in 0.14 s
Operator `forward` ran in 0.33 s
Operator `gradient` ran in 0.15 s
Operator `forward` ran in 0.34 s
Operator `gradient` ran in 0.15 s
Operator `forward` ran in 0.34 s
Operator `gradient` ran in 0.14 s
Operator `forward` ran in 0.33 s
Operator `gradient` ran in 0.15 s
Operator `forward` ran in 0.29 s
Operator `gradient` ran in 0.15 s
Operator `forward` ran in 0.27 s
Operator `gradient` ran in 0.16 s
Operator `forward` ran in 0.33 s
Operator `gradient` ran in 0.15 s
Operator `forward` ran in 0.34 s
Operator `gradient` ran in 0.16 s
Operator `forward` ran in 0.37 s
Operator `gradient` ran in 0.21 s
Operator `forward` ran in 0.27 s
Operator `gradient` ran in 0.14 s
Operator `forward` ran in 0.34 s
Operator `gradient` ran in 0.14 s
Operator `forward` ran in 0.24 s
Operator `gradient` ran in 0.15 s
[33m[1mâ”Œ [22m[39m[33m[1mWarning: [22m[39mJOLI linear operator, returning julia Array
[33m[1mâ”” [22m[39m[90m@ JUDI ~/.julia/dev/JUDI/src/TimeModeling/Types/ModelStructure.jl:217[39m</code></pre><pre><code class="language-julia">figure(figsize=(12, 4))
plot_simage(reshape(rtmlow, model.n)&#39;, model.d; new_fig=false, name=&quot;Low frequency FWI gradient&quot;, cmap=seiscm(:bwr))</code></pre><pre><code class="language-none">[33m[1mâ”Œ [22m[39m[33m[1mWarning: [22m[39mDeprecated model.n, use size(model)
[33m[1mâ”‚ [22m[39m  caller = ip:0x0
[33m[1mâ”” [22m[39m[90m@ Core :-1[39m
[33m[1mâ”Œ [22m[39m[33m[1mWarning: [22m[39mDeprecated model.d, use spacing(model)
[33m[1mâ”‚ [22m[39m  caller = ip:0x0
[33m[1mâ”” [22m[39m[90m@ Core :-1[39m</code></pre><p><img src="../07_preconditionners_files/07_preconditionners_26_1.png" alt="png"/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../06_automatic_differentiation/">Â« Automatic differentiation with JUDI</a><a class="docs-footer-nextpage" href="../imaging_conditions/">Imaging conditions in JUDI Â»</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Tuesday 5 December 2023 16:48">Tuesday 5 December 2023</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
